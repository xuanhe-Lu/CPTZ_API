Ext.namespace("Ext.fjs.um.admin.manage");Ext.fjs.um.admin.manage.g_url="/fjs/um_admin.do";Ext.fjs.um.admin.manage.detailWindow=Ext.extend(Ext.Window,{constructor:function(){this.dform=new Ext.form.FormPanel({cls:"x-panel-mc",layout:"html",layoutConfig:{css:"fjs-form",template:"fjs/ums_detail.tpl"},style:"padding-top:0px",items:[{xtype:"displayfield",fieldLabel:"会员名称",name:"LOGINNAME",boldLabel:true,width:170},{xtype:"displayfield",fieldLabel:"user.msg.username",name:"USERNAME",boldLabel:true,width:170},{xtype:"displayfield",fieldLabel:"是否管理员",name:"ISSUPER",boldLabel:true,width:150},{xtype:"displayfield",fieldLabel:"状态",name:"STATUS",boldLabel:true,width:200},{xtype:"displayfield",fieldLabel:"当前职位",name:"JOBID",boldLabel:true,width:170},{xtype:"displayfield",fieldLabel:"所属组织",name:"ORGID",boldLabel:true,width:170},{xtype:"displayfield",fieldLabel:"所属部门",name:"DEPTID",width:170},{xtype:"displayfield",fieldLabel:"菜单方案",name:"MENUID",width:170}]});Ext.fjs.um.admin.manage.detailWindow.superclass.constructor.call(this,{iconCls:"btn-detail1",title:"详情页面",width:680,autoHeight:true,autoScroll:true,border:false,closable:true,closeAction:"hide",modal:true,plain:true,resizable:false,items:[this.dform],buttonAlign:"center",buttons:[{iconCls:"btn-stop1",text:"关闭",handler:this.window_close,scope:this}]})},window_close:function(){this.hide()},open:function(g){var get=Ext.fjs.getPKId;this.dform.getForm().setValues({LOGINNAME:get(g,"LOGINNAME"),USERNAME:get(g,"USERNAME"),ISSUPER:get(g,"ISSUPER"),STATUS:get(g,"STATUS"),MENUID:get(g,"MENUID"),DEPTID:get(g,"DEPTID"),JOBID:get(g,"JOBID"),ORGID:get(g,"ORGID")});this.show()}});Ext.fjs.um.admin.manage.AddWindow=Ext.extend(Ext.Window,{constructor:function(grid){this.grid=grid;this.form=new Ext.form.FormPanel({cls:"x-panel-mc",layout:"html",layoutConfig:{css:"fjs-form",template:"fjs/ums_add.tpl"},style:"padding-top:0px",items:[{xtype:"textfield",fieldLabel:"用户编号",name:"USERNO",allowBlank:true,boldLabel:true,width:170,maxLength:20},{xtype:"textfield",fieldLabel:"会员名称",name:"LOGINNAME",allowBlank:false,boldLabel:true,width:170,maxLength:20},{xtype:"textfield",fieldLabel:"登录密码",name:"PASSWORD",id:"password1",allowBlank:true,boldLabel:true,inputType:"password",width:170,maxLength:15},{xtype:"textfield",fieldLabel:"确认密码",name:"REPWD",allowBlank:false,boldLabel:true,inputType:"password",vtype:"password",vtypeText:"您输入的两次密码不一致！",initialPassField:"password1",width:170,maxLength:15,scope:this},{xtype:"textfield",fieldLabel:"真实名称",name:"USERNAME",allowBlank:false,boldLabel:true,width:170,maxLength:20},{xtype:"fjs-store-radio",fieldLabel:"是否管理员",name:"ISSUPER",allowBlank:false,boldLabel:true,dictId:"system.user.type",width:150,groupcfg:{name:"ISSUPER"}},{xtype:"fjs-tree-combo",fieldLabel:"当前职位",name:"JOBID",passName:"JOBID",allowBlank:false,allowUnLeafClick:true,boldLabel:true,width:170,listWidth:200,tP:{rootVisible:false,root:{id:"0",text:"当前职位"},sync:false,url:"fjs/um_jobs.do?action=tree"}},{xtype:"fjs-tree-combo",fieldLabel:"所属组织",name:"ORGID",passName:"ORGID",allowBlank:false,allowUnLeafClick:true,boldLabel:true,width:170,listWidth:200,tP:{rootVisible:false,root:{id:"0",text:"所属组织"},sync:false,url:"fjs/um_orgs.do?action=tree"}},{xtype:"fjs-store-combo",hiddenName:"DEPTID",allowBlank:false,allrec:false,dictUrl:Ext.fjs.um.admin.manage.g_url+"?action=getDept",width:170},{xtype:"fjs-store-combo",hiddenName:"MENUID",allowBlank:false,allrec:false,dictId:"fjs.menubar.template",width:170}]});Ext.fjs.um.admin.manage.AddWindow.superclass.constructor.call(this,{iconCls:"btn-add",title:"账号添加",width:680,autoHeight:true,autoScroll:true,border:false,closable:true,closeAction:"hide",modal:true,plain:true,resizable:false,items:[this.form],buttonAlign:"center",buttons:[{iconCls:"btn-accept1",text:"提交",handler:this.window_submit,scope:this},{iconCls:"btn-stop1",text:"取消",handler:this.window_close,scope:this}]})},window_close:function(){this.hide()},window_submit:function(){if(Ext.fjs.checkValid(this.form)){this.form.getForm().submit(Ext.fjs.saveAction({url:Ext.fjs.um.admin.manage.g_url,params:{action:"add"},success:this.apply_success,scope:this}))}},apply_success:function(form,opts){this.form.getForm().reset();this.window_close();this.grid.refresh()}});Ext.fjs.um.admin.manage.ModWindow=Ext.extend(Ext.Window,{constructor:function(grid){this.grid=grid;this.form=new Ext.form.FormPanel({cls:"x-panel-mc",layout:"html",layoutConfig:{css:"fjs-form",template:"fjs/ums_edit.tpl"},style:"padding-top:0px",items:[{xtype:"hidden",name:"UID"},{xtype:"textfield",fieldLabel:"用户编号",name:"USERNO",allowBlank:true,boldLabel:true,width:170,maxLength:20},{xtype:"textfield",fieldLabel:"会员名称",name:"LOGINNAME",allowBlank:false,boldLabel:true,width:170,maxLength:20},{xtype:"textfield",fieldLabel:"真实名称",name:"USERNAME",allowBlank:false,boldLabel:true,width:170,maxLength:20},{xtype:"fjs-store-radio",fieldLabel:"是否管理员",name:"ISSUPER",allowBlank:false,boldLabel:true,dictId:"system.user.type",width:150,groupcfg:{name:"ISSUPER"}},{xtype:"fjs-tree-combo",fieldLabel:"当前职位",name:"JOBID",passName:"JOBID",allowBlank:false,allowUnLeafClick:true,boldLabel:true,width:170,listWidth:200,tP:{rootVisible:false,root:{id:"0",text:"当前职位"},sync:true,url:"fjs/um_jobs.do?action=tree"}},{xtype:"fjs-tree-combo",fieldLabel:"所属组织",name:"ORGID",passName:"ORGID",allowBlank:false,allowUnLeafClick:true,boldLabel:true,width:170,listWidth:200,tP:{rootVisible:false,root:{id:"0",text:"所属组织"},sync:true,url:"fjs/um_orgs.do?action=tree"}},{xtype:"fjs-store-combo",hiddenName:"DEPTID",allowBlank:false,allrec:false,dictUrl:Ext.fjs.um.admin.manage.g_url+"?action=getDept",width:170},{xtype:"fjs-store-combo",hiddenName:"MENUID",allowBlank:false,allrec:false,dictId:"fjs.menubar.template",width:170}]});Ext.fjs.um.admin.manage.ModWindow.superclass.constructor.call(this,{iconCls:"btn-edit",title:"账号修改",width:680,autoHeight:true,autoScroll:true,border:false,closable:true,closeAction:"hide",modal:true,plain:true,resizable:false,items:[this.form],buttonAlign:"center",buttons:[{iconCls:"btn-accept1",text:"提交",handler:this.window_submit,scope:this},{iconCls:"btn-stop1",text:"取消",handler:this.window_close,scope:this}]})},window_close:function(){this.hide()},window_submit:function(){if(Ext.fjs.checkValid(this.form)){this.form.getForm().submit(Ext.fjs.saveAction({url:Ext.fjs.um.admin.manage.g_url,params:{action:"updateUser"},success:this.apply_success,scope:this}))}},apply_success:function(form,opts){this.form.getForm().reset();this.window_close();this.grid.refresh()},loader_success:function(form,opts){var d=opts.result.data;this.show();form.findField("JOBID").loadValue(d.JOBID);form.findField("ORGID").loadValue(d.ORGID)},open:function(uid){this.form.getForm().load(Ext.fjs.loadAction({url:Ext.fjs.um.admin.manage.g_url,params:{action:"getInfo",uid:uid},success:this.loader_success,scope:this}))}});Ext.fjs.um.admin.manage.PwdWindow=Ext.extend(Ext.Window,{constructor:function(){this.form=new Ext.form.FormPanel({cls:"x-panel-mc",layout:"html",layoutConfig:{css:"fjs-form",template:"fjs/ums_rpwd.tpl"},style:"padding-top:0px",items:[{xtype:"displayfield",name:"LOGIN",width:200},{xtype:"textfield",fieldLabel:"登录密码",name:"PWORD",id:"Pwd1",allowBlank:true,boldLabel:true,inputType:"password",width:200,maxLength:15},{xtype:"textfield",fieldLabel:"确认密码",name:"REPWD",allowBlank:false,boldLabel:true,inputType:"password",vtype:"password",vtypeText:"您输入的两次密码不一致！",initialPassField:"Pwd1",width:200,maxLength:15,scope:this}]});Ext.fjs.um.admin.manage.PwdWindow.superclass.constructor.call(this,{iconCls:"btn-edit",title:"密码修改",width:380,border:false,closable:true,closeAction:"hide",modal:true,plain:true,resizable:false,items:[this.form],buttonAlign:"center",buttons:[{iconCls:"btn-accept1",text:"提交",handler:this.window_submit,scope:this},{iconCls:"btn-stop1",text:"取消",handler:this.window_close,scope:this}]})},window_close:function(){this.hide()},window_submit:function(){if(Ext.fjs.checkValid(this.form)){this.form.getForm().submit(Ext.fjs.saveAction({url:Ext.fjs.um.admin.manage.g_url,params:{action:"updatePwd",uid:this.uid},success:this.apply_success,scope:this}))}},apply_success:function(form,opts){this.form.getForm().reset();this.window_close()},open:function(btn,g){var get=Ext.fjs.getPKId;this.uid=get(g,"UID");this.form.getForm().setValues({LOGIN:get(g,"LOGINNAME")});this.show(btn.id)}});Ext.fjs.um.admin.manage.ToolBar=Ext.extend(Ext.Toolbar,{constructor:function(grid){this.grid=grid;this.dStore=new Ext.data.JsonStore({autoDestroy:true,url:Ext.fjs.um.admin.manage.g_url,baseParams:{action:"getDept"},fields:["id","text"]});this.addBtn=new Ext.Button({iconCls:"btn-add",text:"新增",tooltip:"新增角色",disabled:false,handler:this.add_onclick,scope:this});this.detBtn=new Ext.Button({iconCls:"btn-detail1",text:"详情",tooltip:"请选择一行",disabled:true,handler:this.detail_onclick,scope:this});this.optBtn=new Ext.Button({iconCls:"btn-setting",text:"设置",menu:[{iconCls:"btn-edit",text:"修改资料",tooltip:"请选择一行",disabled:true,handler:this.update_onclick,scope:this},{iconCls:"btn-edit",text:"修改密码",disabled:true,handler:this.modPwd_onclick,scope:this},{iconCls:"btn-delete",text:"删除",tooltip:"请选择一行",disabled:true,handler:this.delete_onclick,scope:this},{iconCls:"btn-accept",text:"启用",disabled:true,handler:this.state_onclick,state:0,scope:this},{iconCls:"btn-stop",text:"停用",disabled:true,handler:this.state_onclick,state:1,scope:this},{iconCls:"mnu-group",text:"关联用户",disabled:true,handler:this.relation_onclick,scope:this}]});this.exportBtn=new Ext.Button({iconCls:"btn-excel",text:"导出",tooltip:"导入Excel数据",handler:function(){},scope:this});Ext.fjs.um.admin.manage.ToolBar.superclass.constructor.call(this,{buttonAlign:"left",items:[{xtype:"label",boldLabel:true,text:"部门:"},this.fDept=new Ext.form.ComboBox({name:"DEPID",hiddenName:"DEPID",allowBlank:true,emptyText:"全部",triggerAction:"all",width:120,store:this.dStore,displayField:"text",valueField:"id"}),{xtype:"tbspacer",width:5},{xtype:"label",boldLabel:true,text:"查询用户:"},this.fKey=new Ext.form.TextField({xtype:"textfield",name:"USERNAME",width:100,maxLength:50}),{xtype:"tbspacer",width:5},{iconCls:"btn-search",tooltip:"查询",handler:this.search_onclick,scope:this},"->",this.addBtn,"-",this.detBtn,"-",this.optBtn,"-",this.exportBtn]})},getUid:function(){return Ext.fjs.getPKId(this.grid,"UID")},refresh:function(){this.grid.getBottomToolbar().doRefresh()},search_onclick:function(){var s=this.grid.getStore();s.setBaseParam("DEPT",this.fDept.getValue());s.setBaseParam("KEY",this.fKey.getValue());this.grid.store.load({params:{start:0,limit:this.grid.getBottomToolbar().pageSize}})},detail_onclick:function(){var w=this.detWin;if(!w){this.detWin=w=new Ext.fjs.um.admin.manage.detailWindow()};w.open(this.grid)},add_onclick:function(btn){if(!this.addWin){this.addWin=new Ext.fjs.um.admin.manage.AddWindow(this)};this.addWin.show()},update_onclick:function(){if(!this.modWin){this.modWin=new Ext.fjs.um.admin.manage.ModWindow(this)};this.modWin.open(this.getUid())},modPwd_onclick:function(btn){if(!this.pwdWin){this.pwdWin=new Ext.fjs.um.admin.manage.PwdWindow()};this.pwdWin.open(btn,this.grid)},state_onclick:function(t){Ext.fjs.post({url:Ext.fjs.um.admin.manage.g_url,params:{action:"state",uid:this.getUid(),state:t.state},success:this.apply_success,scope:this})},delete_onclick:function(){Ext.msg.confirm(Ext.fjs.NOTICE,Ext.fjs.del_confirm,this.delConfirm,this)},delConfirm:function(btn){if(btn=="yes"){Ext.fjs.post({url:Ext.fjs.um.admin.manage.g_url,params:{action:"delete",ids:this.getUid()},success:this.apply_success,scope:this})}},relation_onclick:function(){alert("暂未开放")},apply_success:function(res,opts){var rs=Ext.decode(res.responseText);if(rs.success){this.refresh()}else{Ext.fjs.showError(rs.message)}},beforeDestroy:function(){if(this.addWin)Ext.destroy(this.addWin);if(this.modWin)Ext.destroy(this.modWin);if(this.pwdWin)Ext.destroy(this.pwdWin);if(this.detWin)Ext.destroy(this.detWin);Ext.fjs.um.admin.manage.ToolBar.superclass.beforeDestroy.call(this)}});Ext.fjs.um.admin.manage.MainPanel=Ext.extend(Ext.grid.GridPanel,{constructor:function(){var sm=new Ext.grid.CheckboxSelectionModel();var cm=new Ext.grid.ColumnModel([sm,new Ext.grid.RowNumber(),{header:"用户编号",dataIndex:"USNO",width:65,sortable:true,menuDisabled:false,fixed:false},{header:"会员名称",dataIndex:"LOGINNAME",width:100,sortable:true,menuDisabled:false,fixed:false},{header:"真实名称",dataIndex:"USERNAME",width:100,sortable:true,menuDisabled:false,fixed:false},{header:"所属部门",dataIndex:"DEPTID",width:100,sortable:true,menuDisabled:false,fixed:false},{header:"当前职位",dataIndex:"JOBID",width:100,sortable:true,menuDisabled:false,fixed:false},{header:"所属组织",dataIndex:"ORGID",width:100,sortable:true,menuDisabled:false,fixed:false},{header:"状态",dataIndex:"STATUS",width:100,sortable:true,menuDisabled:false,fixed:false},{header:"菜单方案",dataIndex:"MENUID",width:100,sortable:true,menuDisabled:false,fixed:false}]);this.store=new Ext.fjs.PageStore({url:Ext.fjs.um.admin.manage.g_url,baseParams:{action:"list"},fields:["UID","USNO","LOGINNAME","USERNAME","MENUID","DEPTID","JOBID","ORGID","STATE","STATUS","ISSUPER"]});this.toolBar=new Ext.fjs.um.admin.manage.ToolBar(this);Ext.fjs.um.admin.manage.MainPanel.superclass.constructor.call(this,{region:"center",store:this.store,stripeRows:true,autoScroll:true,boldHeader:true,closable:true,loadMask:true,containerScroll:true,columnLines:true,cm:cm,sm:sm,viewConfig:{forceFit:true},tbar:this.toolBar,bbar:Ext.fjs.PageToolBar({store:this.store})});this.getSelectionModel().on("selectionchange",this.evt_selection,this);this.on("afterrender",this.evt_afterrender);this.on("rowdblclick",this.toolBar.detail_onclick,this.toolBar)},evt_afterrender:function(){this.store.load({params:{start:0,limit:Ext.fjs.defPSize}})},evt_selection:function(sm){var bts=this.toolBar.optBtn.menu.items,len=sm.getCount();if(len<=0){this.toolBar.detBtn.disable();for(var i=0;i<bts.length;i++){bts.itemAt(i).disable()}}else if(len==1){this.toolBar.detBtn.enable();if(sm.getSelected().get("STATE")==0){bts.itemAt(3).disable();bts.itemAt(4).enable()}else{bts.itemAt(3).enable();bts.itemAt(4).disable()};bts.itemAt(0).enable();bts.itemAt(1).enable();bts.itemAt(2).enable();bts.itemAt(5).enable()}else{this.toolBar.detBtn.disable();bts.itemAt(0).disable();bts.itemAt(1).disable();bts.itemAt(2).enable();bts.itemAt(3).disable();bts.itemAt(4).disable();bts.itemAt(5).disable()}},reload:function(){this.getBottomToolbar().doRefresh()},beforeDestroy:function(){Ext.fjs.um.admin.manage.MainPanel.superclass.beforeDestroy.call(this)}});