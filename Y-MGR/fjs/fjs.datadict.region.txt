Ext.namespace('Ext.fjs.datadict.region');
Ext.fjs.datadict.region.g_url='fjs/dict_region.do';
Ext.fjs.datadict.region.winProv=Ext.extend(Ext.Window,{
	constructor:function(tree){
		this.tree=tree;
		this.form=new Ext.FormPanel({
			cls:"x-panel-mc",
			layout:"html",
			layoutConfig:{css:"fjs-form",template:"datadict/region_prov.tpl"},
			style:"padding:0px",
			items:[
				{xtype:"hidden",name:"SID"},
				{xtype:"textfield",name:"CODE",width:80,allowBlank:false,boldLabel:true,minLength:2,maxLength:2},
				{xtype:"textfield",name:"CNA",width:280,allowBlank:false,boldLabel:true,minLength:2,maxLength:100},
				{xtype:"textfield",name:"CNB",width:100,allowBlank:false,boldLabel:true,minLength:2,maxLength:50},
				{xtype:"textfield",name:"ENA",width:100,allowBlank:false,boldLabel:true,minLength:2,maxLength:100},
				{xtype:"textfield",name:"ENB",width:80,allowBlank:false,boldLabel:true,minLength:2,maxLength:20}
			]
		});
		Ext.fjs.datadict.region.winProv.superclass.constructor.call(this,{
			iconCls:"btn-add",
			title:"${dict.title.prov}",
			width:400,
			autoHeight:true,
			border:false,
			closeAction:"hide",
			modal:true,
			plain:true,
			resizable:false,
			items:[this.form],
			buttonAlign:"center",
			buttons:[{iconCls:"btn-accept1",text:"${fzm.btn.confirm}",handler:this.window_submit,scope:this},{iconCls:"btn-stop1",text:"${fzm.btn.cancel}",handler:this.window_close,scope:this}]
		});
	},
	window_close:function(){
		this.setIconClass("btn-add");
		this.form.getForm().reset();
		this.hide();
	},
	window_submit:function(){
		if(Ext.fjs.checkValid(this.form)){
			this.form.getForm().submit(Ext.fjs.saveAction({url:Ext.fjs.datadict.region.g_url,params:{action:"prov"},success:this.apply_success,scope:this}));
		}
	},
	apply_success:function(form,opts){
		this.tree.root.reload();
		this.window_close();
	},
	load:function(btn){
		this.form.getForm().setValues({SID:0});
		this.show(btn.id);
	},
	open:function(btn,node){
		this.setIconClass("btn-edit");
		this.form.getForm().load(Ext.fjs.loadAction({url:Ext.fjs.datadict.region.g_url,params:{action:"getCityInfo",code:node.id},show:true,scope:this}));
	}
});
Ext.fjs.datadict.region.winCity=Ext.extend(Ext.Window,{
	constructor:function(tree){
		this.tree=tree;
		this.form=new Ext.FormPanel({
			cls:"x-panel-mc",
			layout:"html",
			layoutConfig:{css:"fjs-form",template:"datadict/region_city.tpl"},
			style:"padding:0px",
			items:[
				{xtype:"hidden",name:"SID"},
				{xtype:"textfield",name:"CODE",width:80,allowBlank:false,boldLabel:true,minLength:4,maxLength:6},
				{xtype:"textfield",name:"CNA",width:280,allowBlank:false,boldLabel:true,minLength:2,maxLength:100},
				{xtype:"textfield",name:"CNB",width:100,allowBlank:false,boldLabel:true,minLength:2,maxLength:50},
				{xtype:"textfield",name:"ENA",width:100,allowBlank:false,boldLabel:true,minLength:2,maxLength:100},
				{xtype:"textfield",name:"ENB",width:80,allowBlank:false,boldLabel:true,minLength:2,maxLength:20},
				{xtype:"textfield",name:"ZIPCODE",width:100,allowBlank:true,boldLabel:true,maxLength:8},
				{xtype:"textfield",name:"TELCODE",width:100,allowBlank:false,boldLabel:true,maxLength:6},
				{xtype:"textfield",name:"TELNUM",width:80,allowBlank:true,boldLabel:true,maxLength:2}
			]
		});
		Ext.fjs.datadict.region.winCity.superclass.constructor.call(this,{
			iconCls:"btn-add",
			title:"${dict.title.city}",
			width:400,
			autoHeight:true,
			border:false,
			closeAction:"hide",
			modal:true,
			plain:true,
			resizable:false,
			items:[this.form],
			buttonAlign:"center",
			buttons:[{iconCls:"btn-accept1",text:"${fzm.btn.confirm}",handler:this.window_submit,scope:this},{iconCls:"btn-stop1",text:"${fzm.btn.cancel}",handler:this.window_close,scope:this}]
		});
	},
	window_close:function(){
		this.setIconClass("btn-add");
		this.form.getForm().reset();
		this.hide();
	},
	window_submit:function(){
		if(Ext.fjs.checkValid(this.form)){
			this.form.getForm().submit(Ext.fjs.saveAction({url:Ext.fjs.datadict.region.g_url,params:{action:"city"},success:this.apply_success,scope:this}));
		}
	},
	apply_success:function(form,opts){
		this.node.reload();
		this.window_close();
	},
	load:function(btn,node){
		this.node=node.isLeaf()?node.parentNode:node;
		this.form.getForm().setValues({CODE:node.id,SID:0});
		this.show(btn.id);
	},
	open:function(btn,node){
		this.node=node.parentNode;
		this.setIconClass("btn-edit");
		this.form.getForm().load(Ext.fjs.loadAction({url:Ext.fjs.datadict.region.g_url,params:{action:"getCityInfo",code:node.id},show:true,scope:this}));
	}
});
Ext.fjs.datadict.region.winTown=Ext.extend(Ext.Window,{
	constructor:function(tree){
		this.tree=tree;
		this.form=new Ext.FormPanel({
			cls:"x-panel-mc",
			layout:"html",
			layoutConfig:{css:"fjs-form",template:"datadict/region_town.tpl"},
			style:"padding:0px",
			items:[
				{xtype:"hidden",name:"SID"},
				{xtype:"textfield",name:"CODE",width:80,allowBlank:false,boldLabel:true,minLength:4,maxLength:10},
				{xtype:"textfield",name:"CNA",width:280,allowBlank:false,boldLabel:true,minLength:2,maxLength:100},
				{xtype:"textfield",name:"CNB",width:100,allowBlank:false,boldLabel:true,minLength:2,maxLength:50},
				{xtype:"textfield",name:"ENA",width:100,allowBlank:false,boldLabel:true,minLength:2,maxLength:100},
				{xtype:"textfield",name:"ENB",width:80,allowBlank:false,boldLabel:true,minLength:2,maxLength:20},
				{xtype:"textfield",name:"ZIPCODE",width:100,allowBlank:true,boldLabel:true,maxLength:8},
				{xtype:"textfield",name:"TELCODE",width:100,allowBlank:false,boldLabel:true,maxLength:6},
				{xtype:"textfield",name:"TELNUM",width:80,allowBlank:true,boldLabel:true,maxLength:2}
			]
		});
		Ext.fjs.datadict.region.winTown.superclass.constructor.call(this,{
			iconCls:"btn-add",
			title:"${dict.title.town}",
			width:400,
			autoHeight:true,
			border:false,
			closeAction:"hide",
			modal:true,
			plain:true,
			resizable:false,
			items:[this.form],
			buttonAlign:"center",
			buttons:[{iconCls:"btn-accept1",text:"${fzm.btn.confirm}",handler:this.window_submit,scope:this},{iconCls:"btn-stop1",text:"${fzm.btn.cancel}",handler:this.window_close,scope:this}]
		});
	},
	window_close:function(){
		this.setIconClass("btn-add");
		this.form.getForm().reset();
		this.hide();
	},
	window_submit:function(){
		if(Ext.fjs.checkValid(this.form)){
			this.form.getForm().submit(Ext.fjs.saveAction({url:Ext.fjs.datadict.region.g_url,params:{action:"town"},success:this.apply_success,scope:this}));
		}
	},
	apply_success:function(form,opts){
		this.node.reload();
		this.window_close();
	},
	load:function(btn,node){
		this.node=node;
		this.form.getForm().setValues({CODE:node.id,SID:0});
		this.show(btn.id);
	},
	open:function(btn,node){
		this.node=node.parentNode;
		this.setIconClass("btn-edit");
		this.form.getForm().load(Ext.fjs.loadAction({url:Ext.fjs.datadict.region.g_url,params:{action:"getCityInfo",code:node.id},show:true,scope:this}));
	}
});
Ext.fjs.datadict.region.MainPanel=Ext.extend(Ext.tree.TreePanel,{
	constructor:function(grid){
		this.grid=grid;
		this.refBtn=new Ext.Button({iconCls:"btn-refresh",text:"${fzm.btn.refresh}",tooltip:"${fzm.msg.refresh}",handler:this.refresh_onclick,scope:this});
		this.exdBtn=new Ext.Button({iconCls:"btn-expand",text:"${fzm.btn.expand}",tooltip:"${fzm.msg.expand}",handler:this.expandAll,scope:this});
		this.collBtn=new Ext.Button({iconCls:"btn-collapse",text:"${fzm.btn.collapse}",tooltip:"${fzm.msg.collapse}",handler:this.collapseAll,scope:this});
		this.addBtn=new Ext.Button({iconCls:"btn-add",text:"${fzm.btn.new}",tooltip:"${fzm.btn.add}",handler:this.add_onclick,scope:this});
		this.modBtn=new Ext.Button({iconCls:"btn-edit",text:"${fzm.btn.modify}",tooltip:"${fzm.msg.modify}",disabled:true,handler:this.mod_onclick,scope:this});
		this.delBtn=new Ext.Button({iconCls:"btn-delete",text:"${fzm.btn.delete}",tooltip:"${fzm.btn.delete}",disabled:true,handler:this.del_onclick,scope:this});
		Ext.fjs.datadict.region.MainPanel.superclass.constructor.call(this,{
			animate:true,
			animCollapse:false,
			autoScroll:true,
			border:false,
			closable:true,
			useArrows:true,
			rootVisible:false,
			root:{id:"0",type:"root",nodeType:"async"},
			loader:new Ext.tree.TreeLoader({url:Ext.fjs.datadict.region.g_url,baseParams:{action:"getChildrens"}}),
			tbar:[this.refBtn,"-",this.exdBtn,"-",this.collBtn,"-",this.addBtn,"-",this.modBtn,"-",this.delBtn]
		});
		this.on("click",this.evt_click,this)
		this.on("contextmenu",this.show_contextmenu,this);
	},
	evt_click:function(node){
		this.modBtn.enable();
		this.delBtn.enable();
	},
	refresh_onclick:function(){
		this.modBtn.disable();
		this.delBtn.disable();
		this.getSelectionModel().clearSelections();
		this.root.reload();
	},
	add_onclick:function(btn){
		var win,node=this.getSelectionModel().getSelectedNode();
		code=(node)?node.id:0;
		if(code<10){
			if(this.provWin==null){
				this.provWin=new Ext.fjs.datadict.region.winProv(this);
			}
			win=this.provWin;
		}else if(code<10000){
			if(this.cityWin==null){
				this.cityWin=new Ext.fjs.datadict.region.winCity(this);
			}
			win=this.cityWin;
		}else{
			if(this.townWin==null){
				this.townWin=new Ext.fjs.datadict.region.winTown(this);
			}
			win=this.townWin;
		}
		win.load(btn,node);
	},
	mod_onclick:function(btn){
		var win,node=this.getSelectionModel().getSelectedNode();
		if(node.id<=99){
			if(this.provWin==null){
				this.provWin=new Ext.fjs.datadict.region.winProv(this);
			}
			win=this.provWin;
		}else if(node.id<=999999){
			if(this.cityWin==null){
				this.cityWin=new Ext.fjs.datadict.region.winCity(this);
			}
			win=this.cityWin;
		}else{
			if(this.townWin==null){
				this.townWin=new Ext.fjs.datadict.region.winTown(this);
			}
			win=this.townWin;
		}
		win.open(btn,node);
	},
	del_onclick:function(){
		Ext.msg.confirm(Ext.fjs.NOTICE,Ext.fjs.del_confirm,this.delConfirm,this);
	},
	delConfirm:function(btn){
		if(btn=="yes"){
			var node=this.getSelectionModel().getSelectedNode();
			Ext.fjs.post({url:Ext.fjs.datadict.region.g_url,params:{action:"delete",code:node.id},success:this.del_success,scope:this});
		}
	},
	del_success:function(res,opts){
		var rs=Ext.decode(res.responseText);
		if(rs.success){
			var node=this.getSelectionModel().getSelectedNode().parentNode;
			if(node.parentNode){node.parentNode.reload();}else{this.root.reload();}
		}else{
			Ext.fjs.showError(rs.message);
		}
	},
	beforeDestroy:function(){
		if(this.provWin)Ext.destroy(this.provWin);
		if(this.cityWin)Ext.destroy(this.cityWin);
		if(this.townWin)Ext.destroy(this.townWin);
		Ext.fjs.datadict.region.MainPanel.superclass.beforeDestroy.call(this);
	}
});
